%%________________________________________________________________________
%% LEIM | PROJETO
%% 2022 / 2013 / 2012
%% Modelo para relatório
%% v04: alteração ADEETC para DEETC; outros ajustes
%% v03: correção de gralhas
%% v02: inclui anexo sobre utilização sistema controlo de versões
%% v01: original
%% PTS / MAR.2022 / MAI.2013 / 23.MAI.2012 (construído)
%%________________________________________________________________________




%%________________________________________________________________________
\chapter{Introdução}
\label{ch:introducao}
%%________________________________________________________________________

Este trabalho visa criar um jogo em Unity \cite{Unity}, utilizando os conhecimentos adquiridos ao longo do semestre, nomeadamente geração procedimental, aprendizagem automática e interação Pessoa-Máquina.

O projeto consiste na criação de um mundo Minecraft \cite{Minecraft}, onde agentes são treinados a desempenhar determinadas tarefas e o jogador consegue interagir com o ambiente, modificando o curso dos acontecimentos.

Este documento está organizado da seguinte forma:

O próximo capítulo trata tudo relacionado com o ambiente, nomeadamente a forma como foi criado e o tipo de blocos.

Os agentes autónomos deste projeto são explicados no terceiro capítulo, assim a maneira como foram treinados.

O quarto capítulo ilustra a interface do jogo.

As ações que o jogador consegue tomar, nomeadamente a sua interação com o microfone, rato e teclado é explicado no quinto capítulo.

No sexto e último capítulo encontra-se a conclusão final do projeto.


%%________________________________________________________________________
\chapter{Ambiente}
\label{ch:ambiente}
%%________________________________________________________________________

Neste capítulo será ilustrado a forma como o terreno é criado, os tipos de blocos existentes no jogo, o aspeto do céu e os sons que gera.

%%________________________________________________________________________
\section{Terreno}
\label{sec:terreno}
%%________________________________________________________________________

A construção do terreno deste projeto é semelhante à do primeiro trabalho prático. Para ser possível termos um mundo infinito, é necessário este estar otimizado, de forma a diminuir o peso computacional. Assim, um mundo é criado continuamente em torno do agente à medida que este se movimenta e por conseguinte, parte do mundo é destruído quando este se afasta
consideravelmente.

Como dito anteriormente, este projeto visa a criação de um mundo
\emph{Minecraft} \cite{Minecraft}, ou seja um mundo baseado em cubos. Neste ambiente, existem
faces que não são visíveis ao jogador, mas que ao serem criadas e
renderizadas tornam a execução mais lenta. Assim, de forma a reduzir o
número de triângulos, vértices, etc, e melhorarmos o desempenho, não
processámos estas faces.

%%________________________________________________________________________
\subsection{Ruído de Perlin}
\label{subsec:ruidoperlin}
%%________________________________________________________________________

O ruído de Perlin \cite{PerlinNoise} é uma técnica muito usada em jogos e utiliza uma série
de números parcialmente aleatórios com o objetivo de imitar objetos naturais,
como o sol, nuvens, animações, terrenos, entre outros, e permite o controlo de
elementos em pequena e grande escala. Utilizamos este ruído de Perlin na nivelação do nosso terreno, ou seja quanto maior for a sua regularização, mais nivelado ficará o terreno.

%%________________________________________________________________________
\subsection{Algoritmo Flood Fill}
\label{subsec:floodfill}
%%________________________________________________________________________

De modo a ser possível construir os diferentes tipos de blocos,
utilizamos o algoritmo de Flood Fill \cite{FloodFill} que os desenha recursivamente. Em termos
gerais, este algoritmo determina a área conectada num nó, dado em um vetor
multi-dimensional de nós. Isto possibilita-nos a gerar mais do que um bloco do
mesmo tipo, criando assim blocos vizinhos.


%%________________________________________________________________________
\section{Blocos}
\label{sec:blocos}
%%________________________________________________________________________

Existem diferentes tipos de bloco neste mundo Minecraft, onde foi utilizado a textura da figura \ref{fig:atlas} para o atlas.

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.3]{./atlas.jpg}
	\caption{Block Atlas}
	\label{fig:atlas}
\end{figure}

Os tipos de blocos utilizados neste projeto são os seguintes: parte de cima da relva (2,6); lado da relva (3,15); pedra (0,14); terra (2,15); diamante (2,12); azul (0,6); roxo (1,3); laranja (2,2). 


%%________________________________________________________________________
\section{Skybox}
\label{sec:skybox}
%%________________________________________________________________________

Foi acrescentado neste trabalho uma skybox para tornar o ambiente do
jogo mais apelativo e haver a existência de dia e noite no jogo. No total foram
usadas 4 skyboxes que trocam entre si sequencialmente de 30 em 30 segundos
para simular as 4 fases do dia (manhã, dia, pôr do sol, noite). O resultado final
foi o seguinte:

\begin{figure}[H]
	\centering
	\includegraphics{./sky1.png}
	\caption{Skybox dia}
	\label{fig:sky1}
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics{./sky2.png}
	\caption{Skybox por do sol}
	\label{fig:sky2}
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics{./sky3.png}
	\caption{Skybox nascer sol}
	\label{fig:sky3}
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics{./sky4.png}
	\caption{Skybox noite}
	\label{fig:sky4}
\end{figure}






%%________________________________________________________________________
\section{Mundo Escondido}
\label{subsec:mundoescondido}

De modo a dar uma funcionalidade extra ao jogo, existe um mundo que, inicialmente, se encontra escondido ao jogador. Para ser possível interagir com este mundo, é necessário colecionar 20 blocos de terra, 10 de pedra e 6 de diamante. Neste mundo é gerado de uma forma mais aleatória, onde octaves e smooth tomam diferentes valores e altera a skybox (figura \ref{fig:skyHidden}).

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.5]{./skyHidden.png}
	\caption{Skybox Mundo Escondido}
	\label{fig:skyHidden}
\end{figure}

%%________________________________________________________________________

%%________________________________________________________________________
\section{Som}
\label{sec:som}
%%________________________________________________________________________

Colocámos um efeito sonoro bastante simples, curto e cativante quando o jogador constrói um cubo. Experimentámos colocar um ambiente de fundo também, no entanto ficou muito repetitivo e monótono, acabando por retirar a música ambiente e deixar apenas um efeito sonoro.

%%________________________________________________________________________
\section{B-spline}
\label{sec:bspline}


De forma a preencher e embelezar o ambiente, foram colocados dragões a voar pelo céu. Isto foi possível com a inclusão de B-splines que definem a trajetória do dragão, utilizando uma biblioteca chamada \aspas{PathCreator} que permite desenhar um caminho específico. Assim, enquanto o jogo estiver a decorrer, eles seguirão o trajeto e dão a sensação de vida ao jogo.

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.5]{./dragao2.png}
	\caption{Dragões}
	\label{fig:dragao}
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.75]{./dragaoBPline.png}
	\caption{Dragão Animação}
	\label{fig:dragaoanimacao}
\end{figure}



%%________________________________________________________________________

%%________________________________________________________________________
\chapter{Agentes}
\label{ch:agentes}
%%________________________________________________________________________

Aqui são identificados os agentes autónomos do projeto e a forma como foram treinados. 

%%________________________________________________________________________
\section{Variedade}
\label{sec:variedade}
%%________________________________________________________________________

Dois dos agentes autónomos são a presa e o predador. Ambos correspondem a aves, um pintassilgo e uma águia. O objetivo do predador é apanhar a presa, e da mesma forma, o pintassilgo tenta fugir da águia. O seu propósito é dar uma maior diversidade ao ambiente, permitindo ao jogador focar-se mais no mundo Minecraft. 


\begin{figure}[H]
	\centering
	\includegraphics[scale=0.75]{./aves.png}
	\caption{Aves}
	\label{fig:aves}
\end{figure}

Também foi reutilizado o agente do segundo trabalho prático. Durante a exploração do mundo, o jogador encontrará ovelhas treinadas a executar uma ação, nomeadamente irem até ao local correto.

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.75]{./ovelhas.png}
	\caption{Ovelhas}
	\label{fig:ovelhas}
\end{figure}


%%________________________________________________________________________
\section{ML-Agents}
\label{sec:mlagents}
%%________________________________________________________________________

O Unity Machine Learning Agents Toolkit (ML-Agents)  \cite{MLAgents} consiste num projeto de
código aberto, onde jogos e simulações podem servir como ambientes para efetuar o treino de agentes inteligentes. 

Os agentes autónomos foram assim treinados com esta ferramenta. Recorrendo a uma aprendizagem por reforço, os agentes conseguem identificar (através de Raycasts) o seu predador (no caso do pintassilgo) ou a sua presa (se for uma águia).

A metodologia de treinamento foi bastante simples: quando as diferentes aves se tocam, a águia recebe uma recompensa positiva e o pintassilgo uma negativa. o predador continuamente recebe uma penalização mínima, ao contrária da presa que é continuamente beneficiado. 


O ambiente das ovelhas consiste num plano onde o agente se consegue movimentar, quatro cubos escalados a fazer de paredes e três quads. Os dois mais afastados representam as duas possibilidades de resposta, e o central a informação necessária para o agente conseguir concluir a tarefa. Isto é, se o quad central for um O ele terá de tocar no O e se for um X
ele terá de tocar no X. A posição onde o agente começa é aleatória, no entanto é sempre antes do quad central (na metade do plano mais afastada dos dois quads - X e O). A imagem do quad central é aleatória podendo ser um X ou um círculo e os dois quads mais afastados são de
posição fixa. 

%%________________________________________________________________________
\section{Ficheiro de Configuração}
\label{sec:ficheiroconfiguracao}
%%________________________________________________________________________

De modo a treinar um agente, é necessário um ficheiro \aspas{. yaml} de configuração, onde é possível definir inúmeros parâmetros diferentes. O ficheiro utilizado encontra-se na figura \ref{fig:config}.

\begin{figure}[h]
	\centering
	\includegraphics{./config.png}
	\caption{Ficheiro de Configuração Presa e Predador}
	\label{fig:config}
\end{figure}

Devido ao número total de parâmetros possíveis definir ser muito elevado, iremos
dar uma breve explicação dos que foram utilizados neste trabalho:

\begin{itemize}
	\item batch size - número de experiências de cada iteração.
	\item buffer size - número de experiências colecionadas antes de atualizar o modelo;
	\item learning rate - corresponde à taxa de aprendizagem;
	\item Beta - corresponde à força de regularização entrópico. Quanto maior for este valor, mais ações aleatórias são tomadas;
	\item Epsilon - influencia a rapidez com que a política evolui durante o treino.	Estamos a utilizar o valor por omissão 0.2;
	\item Lambd - parâmetro de regularização com valor por defeito de 0.95.
	Significa o quão um agente depende dos valores atuais. Se este
	parâmetro possuir um valor baixo, significa que dependerá mais,
	enquanto que valores altos fazem com que dependa mais nas
	recompensas recebidas no ambiente
	\item Num epoch - também o valor por defeito 3, corresponde ao número de
	passagens a serem feitas pelo buffer ao realizar a otimização de descida
	de gradiente
	\item Learning rate schedule - para o nosso tipo de treino (ppo) o valor de
	defeito é linear. Este decrementa o learning rate de forma linear,
	chegando a 0 no \aspas{max steps};
	\item Normalize - valor booleano que diz se a normalização é aplicada ao
	vetor de observações de entrada;
	\item Hidden units - o range varia tipicamente entre 32 e 512, no nosso caso
	estamos a usar o valor 128 que é o valor por omissão. Este, corresponde
	ao número de unidades que estão completamente conectadas à
	camada da rede neural;
	\item Num layers - número de camadas escondidas na rede neural (valor por
	defeito é 2);
	\item Gamma - fator de desconto de recompensas futuras a vir do
	ambiente;
	\item Strength - fator a ser multiplicado pela recompensa dada pelo
	ambiente;
	\item keep checkpoints - número máximo de \aspas{pontos de controle} de modelos
	a manter. Estamos a usar o valor por defeito (5);
	\item Max steps - número total de passos que devem ser tomados no ambiente
	antes do treino terminar;
	\item Time horizon - Estamos a usar o valor por defeito (64). Significa o número
	de passos de experiência que cada agente coleciona antes de
	adicionar ao buffer;
	\item Summary freq - número de experiências que necessitam ser coletadas
	antes de gerar e mostrar as estatísticas de treino;
	
\end{itemize}

O ficheiro de configuração das ovelhas é possível ser visualizado na figura \ref{fig:hallway}.

\begin{figure}[h]
	\centering
	\includegraphics{./hallway.png}
	\caption{Ficheiro de Configuração Ovelhas}
	\label{fig:hallway}
\end{figure}

%%________________________________________________________________________
\chapter{Interface}
\label{ch:interface}
%%________________________________________________________________________

Este capítulo ilustra a interface do jogo.

%%________________________________________________________________________
\section{Menu Principal}
\label{sec:menu}
%%________________________________________________________________________

O jogador consegue navegar pelo menu principal clicando com o rato nos botões, ou através do microfone como veremos no próximo capítulo.

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.5]{./mainMenu.png}
	\caption{Menu Principal}
	\label{fig:menuprincipal}
\end{figure}

Os nomes são bastante sugestivos: \emph{Play Game} inicia o jogo; \emph{Help} indica os comandos e mecânicas do jogo; \emph{Quit} o utilizado sai do jogo.

%%________________________________________________________________________
\section{Menu de Jogo}
\label{sec:menujogo}
%%________________________________________________________________________

Durante o jogo, a interface indica ao jogador o tipo de bloco que tem selecionado, o número de blocos e também qual o bloco seguinte, se o jogador desejar alterar (figura \ref{fig:menujogo}). 

\begin{figure}[h]
	\centering
	\includegraphics[scale=0.4]{./menuIngame.png}
	\caption{Menu de Jogo}
	\label{fig:menujogo}
\end{figure}

Na situação do jogador tentar entrar no mundo escondido sem possuir os materiais necessários, um aviso será mostrado (figura \ref{fig:semmateriais}).

\begin{figure}[h]
	\centering
	\includegraphics[scale=0.4]{./menuIngame2.png}
	\caption{Materiais Insuficientes}
	\label{fig:semmateriais}
\end{figure}

Na figura \ref{fig:menumundoescondido} é possível visualizar como os blocos de alteram entre os mundos.

\begin{figure}[h]
	\centering
	\includegraphics[scale=0.4]{./menuIngameHirren.png}
	\caption{Menu Mundo Escondido}
	\label{fig:menumundoescondido}
\end{figure}


%%________________________________________________________________________
\chapter{Interação}
\label{ch:interacao}
%%________________________________________________________________________

Este capítulo trata a forma como o jogador interage com o ambiente, nomeadamente recorrendo ao teclado e microfone.

%%________________________________________________________________________
\section{Rato e Teclado}
\label{sec:teclado}
%%________________________________________________________________________

Com o movimento do rato, o jogador consegue ajustar a câmara e, caso um dos botões do rato seja premido (direito ou esquerdo), um cubo será criado ou destruído, respetivamente.

Caso o jogador possua quatro blocos de pedra, ele tem a possibilidade de criar uma picareta premindo a tecla M. Esta tem o intuito de minar blocos diamante. Este objeto é uma funcionalidade inspirada no \emph{Minecraft} original, onde os jogadores apenas conseguiam mineram diamante caso possuíssem uma picareta de ferro. 

Para facilitar a movimentação entre o mundo, consegue saltar clicando no espaço do teclado.

O jogador apenas consegue criar cubos se tiver os respetivos tipos no inventário (são colocados na destruição de determinado cubo). 


%%________________________________________________________________________
\section{Microfone}
\label{sec:microfone}
%%________________________________________________________________________

Para ser possível interagir com o jogo através de áudio, utilizou-se um exemplo dado na aula, nomeadamente se o microfone detetar um som acima de 40 decibéis e a concentração no pico da frequência for superior a um dado valor então assume-se que é um assobio e o jogador irá andar para a frente. 

Assobiar irá trocar o tipo de bloco que o jogador consegue construir. Estes alteram-se num ciclo predeterminado consoante o mundo atual (original ou escondido).

Utilizou-se também uma biblioteca do \emph{Unity} chamada KeywordRecognizer. Esta classe permite detetar palavras em inglês e chamar determinadas funções como indica a seguinte tabela:

\begin{table}[h]
	\centering
	\begin{tabular}{ |c|c|c|c| } 
		\hline
		\textbf{Comandos} & 	\textbf{Funcionalidades} 
		\\
		\hline
		New & Tenta entrar no mundo escondido
		\\ \hline
		Menu & Menu principal
		\\
		\hline 
		Old & Mundo original
		\\
		\hline 
		Help & Abre o manual de instruções
		\\
		\hline 
		Start & Inicia o jogo 
		\\
		\hline 
	\end{tabular}
	\caption{Comandos de Voz}
	\label{tab:comandosvoz}
\end{table}




%%________________________________________________________________________
\chapter{Conclusão}
\label{ch:conclusao}
%%________________________________________________________________________

Pode-se concluir que os objetivos do projeto foram concluídos. Todos os temas lecionados ao longo do semestre foram agregados, nomeadamente geração procedimental com a construção de um mundo \emph{Minecraft} \cite{Minecraft}, aprendizagem automática onde diferentes agentes foram treinados e interação Pessoa-Máquina de modo a ser possível ao utilizador interagir e alterar o curso dos acontecimentos.  

Assim, foi possível consolidar os conhecimentos adquiridos ao longo das aulas, que já tinham sido postos em prática nos mini-projetos, em algo mais complexo e onde, havendo inúmeras funcionalidades adicionais que possam ser criadas, seja possível explorar estes conceitos livremente.


